<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="OpenCode权限系统 - 工具权限配置和安全控制">
  <title>5.4 权限系统 - OpenCode深度教程</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
</head>
<body>
  <nav class="navbar">
    <button class="mobile-menu-btn" aria-label="菜单"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
    <a href="../index.html" class="navbar-brand"><div class="logo">OC</div><span>OpenCode深度教程</span></a>
    <div class="navbar-nav"><a href="../index.html">首页</a><a href="1.1-what-is-opencode.html">教程</a><a href="../community.html">社群</a><a href="https://opencode.ai/docs" target="_blank">官方文档</a><a href="https://github.com/anomalyco/opencode" target="_blank">GitHub</a></div>
    <div class="navbar-right">
      <div class="search-box"><svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><input type="text" class="search-input" placeholder="搜索教程..."><div class="search-results"></div></div>
      <button class="theme-toggle" aria-label="切换主题"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button>
    </div>
  </nav>

  <aside class="sidebar"><div class="sidebar-content"><div class="sidebar-section"><div class="sidebar-title">第一章：入门指南</div><ul class="sidebar-nav"><li><a href="1.1-what-is-opencode.html"><span class="chapter-number">1.1</span>什么是OpenCode</a></li><li><a href="1.2-installation.html"><span class="chapter-number">1.2</span>安装OpenCode</a></li><li><a href="1.3-quickstart.html"><span class="chapter-number">1.3</span>快速开始</a></li><li><a href="1.4-terminal-requirements.html"><span class="chapter-number">1.4</span>终端要求</a></li></ul></div><div class="sidebar-section"><div class="sidebar-title">第二章：基础配置</div><ul class="sidebar-nav"><li><a href="2.1-config-file.html"><span class="chapter-number">2.1</span>配置文件详解</a></li><li><a href="2.2-providers.html"><span class="chapter-number">2.2</span>AI提供商配置</a></li><li><a href="2.3-models.html"><span class="chapter-number">2.3</span>模型选择与配置</a></li><li><a href="2.4-environment.html"><span class="chapter-number">2.4</span>环境变量设置</a></li></ul></div><div class="sidebar-section"><div class="sidebar-title">第三章：界面操作</div><ul class="sidebar-nav"><li><a href="3.1-tui.html"><span class="chapter-number">3.1</span>TUI终端界面</a></li><li><a href="3.2-cli.html"><span class="chapter-number">3.2</span>CLI命令行接口</a></li><li><a href="3.3-web.html"><span class="chapter-number">3.3</span>Web界面</a></li><li><a href="3.4-ide.html"><span class="chapter-number">3.4</span>IDE集成</a></li></ul></div><div class="sidebar-section"><div class="sidebar-title">第四章：核心功能</div><ul class="sidebar-nav"><li><a href="4.1-tools.html"><span class="chapter-number">4.1</span>内置工具详解</a></li><li><a href="4.2-commands.html"><span class="chapter-number">4.2</span>斜杠命令</a></li><li><a href="4.3-keybinds.html"><span class="chapter-number">4.3</span>快捷键参考</a></li><li><a href="4.4-file-reference.html"><span class="chapter-number">4.4</span>文件引用与搜索</a></li></ul></div><div class="sidebar-section"><div class="sidebar-title">第五章：高级配置</div><ul class="sidebar-nav"><li><a href="5.1-agents.html"><span class="chapter-number">5.1</span>Agents代理系统</a></li><li><a href="5.2-rules.html"><span class="chapter-number">5.2</span>Rules规则配置</a></li><li><a href="5.3-themes.html"><span class="chapter-number">5.3</span>主题配置</a></li><li><a href="5.4-permissions.html" class="active"><span class="chapter-number">5.4</span>权限系统</a></li></ul></div><div class="sidebar-section"><div class="sidebar-title">第六章：扩展功能</div><ul class="sidebar-nav"><li><a href="6.1-lsp.html"><span class="chapter-number">6.1</span>LSP语言服务器</a></li><li><a href="6.2-formatters.html"><span class="chapter-number">6.2</span>代码格式化器</a></li><li><a href="6.3-custom-commands.html"><span class="chapter-number">6.3</span>自定义命令</a></li><li><a href="6.4-mcp.html"><span class="chapter-number">6.4</span>MCP协议服务器</a></li></ul></div><div class="sidebar-section"><div class="sidebar-title">第七章：开发与集成</div><ul class="sidebar-nav"><li><a href="7.1-sdk.html"><span class="chapter-number">7.1</span>SDK使用指南</a></li><li><a href="7.2-network.html"><span class="chapter-number">7.2</span>网络配置</a></li><li><a href="7.3-enterprise.html"><span class="chapter-number">7.3</span>企业版功能</a></li><li><a href="7.4-troubleshooting.html"><span class="chapter-number">7.4</span>故障排除</a></li></ul></div></div></aside>

  <main class="main-content">
    <nav class="breadcrumb">
      <a href="../index.html">首页</a>
      <span class="breadcrumb-separator">/</span>
      <a href="5.1-agents.html">第五章</a>
      <span class="breadcrumb-separator">/</span>
      <span>权限系统</span>
    </nav>

    <article>
      <header class="article-header">
        <h1 class="article-title">5.4 权限系统</h1>
        <div class="article-meta">
          <span class="tag">高级配置</span>
          <span>第五章：高级配置</span>
        </div>
      </header>

      <div class="article-content">
        <p>权限系统是OpenCode的安全核心，通过精细的权限控制，可以确保AI助手在安全的边界内工作。</p>

        <h2>三种权限状态</h2>
        <p>每个工具都可以配置为以下三种权限状态之一：</p>

        <table>
          <thead><tr><th>状态</th><th>说明</th><th>使用场景</th></tr></thead>
          <tbody>
            <tr>
              <td><code>allow</code></td>
              <td>自动执行，无需确认</td>
              <td>信任的操作，如读取文件、搜索代码</td>
            </tr>
            <tr>
              <td><code>ask</code></td>
              <td>每次执行前询问用户确认</td>
              <td>需要审查的操作，如执行命令、修改文件</td>
            </tr>
            <tr>
              <td><code>deny</code></td>
              <td>禁止执行</td>
              <td>危险操作或不需要的功能</td>
            </tr>
          </tbody>
        </table>

        <div class="tip-box info">
          <div class="tip-box-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>默认权限</div>
          <div class="tip-box-content">默认情况下，读取类工具（read、grep、glob、list）为 <code>allow</code>，写入类工具（edit、write、bash）为 <code>ask</code>。</div>
        </div>

        <h2>配置结构</h2>

        <h3>基本配置</h3>
        <p>在 <code>opencode.json</code> 中配置全局权限：</p>
        <pre><code>{
  "permission": {
    "read": "allow",
    "grep": "allow",
    "glob": "allow",
    "list": "allow",
    "edit": "ask",
    "write": "ask",
    "bash": "ask",
    "patch": "ask",
    "webfetch": "ask",
    "lsp": "allow"
  }
}</code></pre>

        <h3>细粒度配置</h3>
        <p>可以为特定工具配置更详细的规则：</p>
        <pre><code>{
  "permission": {
    "bash": {
      "default": "ask",
      "rules": [
        {
          "pattern": "npm *",
          "permission": "allow"
        },
        {
          "pattern": "git *",
          "permission": "allow"
        },
        {
          "pattern": "rm -rf *",
          "permission": "deny"
        }
      ]
    }
  }
}</code></pre>

        <h2>通配符匹配</h2>
        <p>权限规则支持通配符模式匹配：</p>

        <table>
          <thead><tr><th>通配符</th><th>说明</th><th>示例</th></tr></thead>
          <tbody>
            <tr><td><code>*</code></td><td>匹配任意字符（不含路径分隔符）</td><td><code>*.js</code> 匹配所有JS文件</td></tr>
            <tr><td><code>**</code></td><td>匹配任意路径</td><td><code>src/**/*.ts</code> 匹配src下所有TS文件</td></tr>
            <tr><td><code>?</code></td><td>匹配单个字符</td><td><code>file?.txt</code> 匹配file1.txt等</td></tr>
            <tr><td><code>[abc]</code></td><td>匹配括号内任一字符</td><td><code>[Rr]eadme</code> 匹配Readme或readme</td></tr>
          </tbody>
        </table>

        <h3>路径规则示例</h3>
        <pre><code>{
  "permission": {
    "edit": {
      "default": "ask",
      "rules": [
        {
          "pattern": "src/**/*.ts",
          "permission": "allow"
        },
        {
          "pattern": "test/**/*",
          "permission": "allow"
        },
        {
          "pattern": "*.config.js",
          "permission": "ask"
        },
        {
          "pattern": "node_modules/**/*",
          "permission": "deny"
        },
        {
          "pattern": ".env*",
          "permission": "deny"
        }
      ]
    }
  }
}</code></pre>

        <h3>命令规则示例</h3>
        <pre><code>{
  "permission": {
    "bash": {
      "default": "ask",
      "rules": [
        {
          "pattern": "npm run *",
          "permission": "allow"
        },
        {
          "pattern": "npm test",
          "permission": "allow"
        },
        {
          "pattern": "npm install *",
          "permission": "ask"
        },
        {
          "pattern": "git status",
          "permission": "allow"
        },
        {
          "pattern": "git diff *",
          "permission": "allow"
        },
        {
          "pattern": "git push *",
          "permission": "ask"
        },
        {
          "pattern": "rm *",
          "permission": "deny"
        },
        {
          "pattern": "sudo *",
          "permission": "deny"
        }
      ]
    }
  }
}</code></pre>

        <h2>可用权限类型</h2>
        <p>以下是所有可配置权限的工具：</p>

        <h3>文件操作</h3>
        <table>
          <thead><tr><th>工具</th><th>说明</th><th>建议权限</th></tr></thead>
          <tbody>
            <tr><td><code>read</code></td><td>读取文件内容</td><td>allow</td></tr>
            <tr><td><code>edit</code></td><td>编辑现有文件</td><td>ask</td></tr>
            <tr><td><code>write</code></td><td>创建或覆盖文件</td><td>ask</td></tr>
            <tr><td><code>patch</code></td><td>应用补丁</td><td>ask</td></tr>
          </tbody>
        </table>

        <h3>搜索操作</h3>
        <table>
          <thead><tr><th>工具</th><th>说明</th><th>建议权限</th></tr></thead>
          <tbody>
            <tr><td><code>grep</code></td><td>搜索文件内容</td><td>allow</td></tr>
            <tr><td><code>glob</code></td><td>按模式查找文件</td><td>allow</td></tr>
            <tr><td><code>list</code></td><td>列出目录内容</td><td>allow</td></tr>
          </tbody>
        </table>

        <h3>执行操作</h3>
        <table>
          <thead><tr><th>工具</th><th>说明</th><th>建议权限</th></tr></thead>
          <tbody>
            <tr><td><code>bash</code></td><td>执行shell命令</td><td>ask</td></tr>
          </tbody>
        </table>

        <h3>扩展操作</h3>
        <table>
          <thead><tr><th>工具</th><th>说明</th><th>建议权限</th></tr></thead>
          <tbody>
            <tr><td><code>webfetch</code></td><td>获取网页内容</td><td>ask</td></tr>
            <tr><td><code>lsp</code></td><td>语言服务器查询</td><td>allow</td></tr>
            <tr><td><code>mcp:*</code></td><td>MCP服务器工具</td><td>ask</td></tr>
          </tbody>
        </table>

        <h2>代理级别自定义</h2>
        <p>可以为不同代理配置不同的权限：</p>

        <h3>限制性代理</h3>
        <pre><code>{
  "agent": {
    "reviewer": {
      "description": "代码审查代理",
      "mode": "primary",
      "permission": {
        "read": "allow",
        "grep": "allow",
        "glob": "allow",
        "list": "allow",
        "edit": "deny",
        "write": "deny",
        "bash": "deny"
      }
    }
  }
}</code></pre>

        <h3>宽松代理</h3>
        <pre><code>{
  "agent": {
    "developer": {
      "description": "开发代理",
      "mode": "primary",
      "permission": {
        "read": "allow",
        "grep": "allow",
        "glob": "allow",
        "list": "allow",
        "edit": "allow",
        "write": "allow",
        "bash": {
          "default": "allow",
          "rules": [
            {
              "pattern": "rm -rf *",
              "permission": "deny"
            },
            {
              "pattern": "sudo *",
              "permission": "deny"
            }
          ]
        }
      }
    }
  }
}</code></pre>

        <h2>权限优先级</h2>
        <p>权限配置的优先级从高到低：</p>
        <ol>
          <li><strong>代理级别规则</strong> - 特定代理的permission配置</li>
          <li><strong>细粒度规则</strong> - 匹配的pattern规则</li>
          <li><strong>工具默认值</strong> - 工具的default设置</li>
          <li><strong>全局默认值</strong> - 系统默认权限</li>
        </ol>

        <h2>安全最佳实践</h2>

        <div class="tip-box warning">
          <div class="tip-box-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>安全建议</div>
          <div class="tip-box-content">
            <ul>
              <li>始终禁止 <code>rm -rf</code> 和 <code>sudo</code> 命令</li>
              <li>保护敏感文件（.env、credentials等）</li>
              <li>对生产环境操作使用 <code>ask</code> 权限</li>
              <li>定期审查权限配置</li>
            </ul>
          </div>
        </div>

        <h3>推荐的安全配置</h3>
        <pre><code>{
  "permission": {
    "read": "allow",
    "grep": "allow",
    "glob": "allow",
    "list": "allow",
    "edit": {
      "default": "ask",
      "rules": [
        { "pattern": ".env*", "permission": "deny" },
        { "pattern": "**/*.key", "permission": "deny" },
        { "pattern": "**/credentials*", "permission": "deny" },
        { "pattern": "src/**/*", "permission": "allow" },
        { "pattern": "test/**/*", "permission": "allow" }
      ]
    },
    "write": {
      "default": "ask",
      "rules": [
        { "pattern": ".env*", "permission": "deny" },
        { "pattern": "node_modules/**/*", "permission": "deny" }
      ]
    },
    "bash": {
      "default": "ask",
      "rules": [
        { "pattern": "npm test", "permission": "allow" },
        { "pattern": "npm run lint", "permission": "allow" },
        { "pattern": "git status", "permission": "allow" },
        { "pattern": "git diff", "permission": "allow" },
        { "pattern": "rm -rf *", "permission": "deny" },
        { "pattern": "sudo *", "permission": "deny" },
        { "pattern": "> /dev/*", "permission": "deny" }
      ]
    }
  }
}</code></pre>

        <h2>运行时权限管理</h2>
        <p>在TUI界面中可以临时调整权限：</p>
        <pre><code># 临时允许所有bash命令
/permission bash allow

# 恢复默认设置
/permission bash ask

# 查看当前权限状态
/permission</code></pre>

        <div class="tip-box info">
          <div class="tip-box-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>临时权限</div>
          <div class="tip-box-content">通过命令修改的权限只在当前会话有效，重启后恢复配置文件设置。</div>
        </div>

        <h2>下一步</h2>
        <p>高级配置部分完成。接下来学习OpenCode的扩展功能，包括LSP语言服务器集成。</p>
      </div>

      <nav class="article-nav">
        <a href="5.3-themes.html" class="article-nav-item prev">
          <div class="article-nav-label">← 上一篇</div>
          <div class="article-nav-title">5.3 主题配置</div>
        </a>
        <a href="6.1-lsp.html" class="article-nav-item next">
          <div class="article-nav-label">下一篇 →</div>
          <div class="article-nav-title">6.1 LSP语言服务器</div>
        </a>
      </nav>
    </article>
  </main>

  <nav class="toc"><div class="toc-title">本页目录</div><ul class="toc-list"></ul></nav>
  <button class="back-to-top" aria-label="回到顶部"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
  <script src="../js/main.js"></script>
</body>
</html>
